<!doctype html>
<html lang="en">

<head>
  <!-- *************************************  Required meta tags *************************************************************** -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <meta name="author" content="TBM" />
  <meta name="description" content="CIFO La Violeta">
  <meta name="keywords" content="formacion, SOC, CIFO, formación digital" />

  <!-- *************************************  Bootstrap CSS *********************************************************************-->
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.css">
  <!-- Fonts CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="css/cifo.css">
  <link rel="icon" href="img/favicon.ico" type="image/gif" sizes="16x16">


  <!-- ************************************   DataTables CSS *******************************************************************-->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.20/css/dataTables.bootstrap4.min.css" />




  <title>CIFO La Violeta</title>
</head>
<!-- ******************************************    data-include BODY   ************************************************************** -->

<body class="container-fluid">
  <div data-include="Nav.html"></div>
  <div data-include="Header.html"></div>



  <div class="row">
    <div class="col-12 col-md-4">
      <div class="card">

        <div class="card-header text-white bg-info">
          <i class="fa fa-filter"></i>
          Filtrar
        </div>
        <div class="card-body">
          Seccion
          <select class="form-control" id="tblSecciones">
            <option value="">-- Elija una opcion --</option>
          </select>
        </div>
        <div class="card-body">
          Temas
          <select class="form-control" id="tblTemas">
            <option value="">-- Elija una opcion --</option>
          </select>
        </div>
        <div class="card-body">
          Editoriales
          <select class="form-control" id="tblEditoriales">
            <option value="">-- Elija una opcion --</option>
          </select>
        </div>
        <div class="d-flex justify-content-center mt-5">
          <button type="button" id="btnFiltrar" class="btn btn-info mr-1">Filtrar</button>
          <button type="button" id="btnBorrar" class="btn btn-danger ml-1">Borrar</button>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-8">
      <div class="card h-100">
        <div class="card-header text-white bg-info">
          <i class="fa fa-book"></i>
          Libros
        </div>
        <div class="card-body">
          <!-- <div class="table-responsive "> -->
            <div class="display responsive nowrap ">
            <table id="tbllibros" class="table small table-striped table-bordered">
              <thead>
                <tr>
                  <th>Isbn</th>
                  <th>Cubierta</th>
                  <th>Titulo</th>
                  <th>Editorial</th>
                  <th>Seccion</th>
                  <th>Tema</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!--********************************************************  MODAL LIBRO  ******************************************************-->

  <div class="modal fade bd-modal-lg" id="ModalLibro" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true ">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalCenterTitle">LIBRO</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-sm-8 col-md-8 col-lg-8">
              <div class="pb-0 pt-1 mx-3 px-0 row">
                <div class="col-6 justify-content-end d-flex text-black-50">Isbn</div>
                <div id="isbnModal" class="col-6 bg-light text-dark"></div>
              </div>
              <div class="pb-0 pt-1 mx-3 px-0 row">
                <div class="col-6 justify-content-end d-flex text-black-50">Titulo</div>
                <div id="tituloModal" class="col-6 bg-light text-dark"></div>
              </div>
              <div class="pb-0 pt-1 mx-3 px-0 row">
                <div class="col-6 justify-content-end d-flex text-black-50">Subtitulo</div>
                <div id="subtituloModal" class="col-6 bg-light text-dark"></div>
              </div>
              <div class="pb-0 pt-1 mx-3 px-0 row">
                <div class="col-6 justify-content-end d-flex text-black-50">Nº de Páginas</div>
                <div id="paginaModal" class="col-6 bg-light text-dark"></div>
              </div>
              <div class="pb-0 pt-1 mx-3 px-0 row">
                <div class="col-6 justify-content-end d-flex text-black-50">Editorial</div>
                <div id="editorialModal" class="col-6 bg-light text-dark"></div>
              </div>
              <div class="pb-0 pt-1 mx-3 px-0 row">
                <div class="col-6 justify-content-end d-flex text-black-50">Añor</div>
                <div id="anoModal" class="col-6 bg-light text-dark"></div>
              </div>

              <div class="pb-2 pt-1 mx-3 px-0 row">
                <div class="col-6 justify-content-end d-flex text-black-50">Tema</div>
                <div id="temaModal" class="col-6 bg-light text-dark"></div>
              </div>
              <div class="pb-2 pt-1 mx-3 px-0 row">
                <div class="col-6 justify-content-end d-flex text-black-50">Sección</div>
                <div id="seccionModal" class="col-6 bg-light text-dark"></div>
              </div>
              <div class="pb-2 pt-1 mx-3 px-0 row">
                <div class="col-6 justify-content-end d-flex text-black-50">Nivel</div>
                <div id="nivelModal" class="col-6 bg-light text-dark"></div>
              </div>
            </div>
            <div class="col-sm-4 col-md-4 col-lg-4">
              <img class="img-responsive align-self-stretch border rounded" style="object-fit:cover" id="fotolibroModal" title="Foto de la cubierta " src="">
            </div>
            <!-- *************************************** MODAL ACCORDION ************************************************************************ -->
            <div class="accordion " id="accordionExample">

              <div data-target="#list-example" data-offset="0" class="scrollspy-example">
                <div class="mx-3">
                  <div id="btnObjetivo" class="modal-body mb-1 mx-0 p-0 row bg-secondary text-white border-secondary rounded-top">
                    <i class="fa fa-align-left mr-2 mt-2 ml-3"></i>
                    <button class=" py-1 pl-0 text-white btn btn-link" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                      Descripcion
                    </button>
                  </div>
                  <div id="collapseOne" class="collapse" aria-labelledby="headingOne" data-parent="#accordionExample">
                    <div class="px-5 mb-1 border border-light card-body"></div>
                    <div class="d-flex justify-content-end">
                      <button id="cerrarObjetivos" type="button" class="mb-1 btn btn-light" data-toggle="collapse" data-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">Cerrar</button>
                    </div>
                  </div>
                </div>
                <div class="mx-3">
                  <div id="btnAutores" class="modal-body mb-1 mx-0 p-0 row bg-secondary text-white border-secondary">
                    <i class="fa fa-user mr-2 mt-2 ml-3"></i>
                    <button class=" py-1 pl-0 text-white btn btn-link" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo">
                      Autores
                    </button>
                  </div>
                  <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionExample">
                    <div class="px-5 mb-1 border border-light card-body"></div>
                    <div class="d-flex justify-content-end">
                      <button id="cerrarAutores" type="button" class="mb-1 btn btn-light" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">Cerrar</button>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ******************************************    data-include FOOTER   ************************************************************** -->
  <div data-include="Footer.html"></div>

  <!-- ***************************************     Optional JavaScript   ************************************************************** -->
  <!-- ***************************************     jQuery first, then Popper.js, then Bootstrap JS ************************************ -->
  <script src="https://code.jquery.com/jquery-3.4.1.min.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" type="text/javascript"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" type="text/javascript"></script>

  <!-- ***************************************     Datatable Js *********************************************************************** -->
  <script type="text/javascript" src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js"></script>



  <script src="js/multipage.js" type="text/javascript"></script>
  <script>
    /* ****************************************   GET Secciones  llamada AJAX   ***************************************************** */

    var xhr;
    xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
      if (xhr.readyState == 4 && xhr.status == 200) {
        var objSecciones = JSON.parse(xhr.responseText);
        var arrSecciones = objSecciones.records;

        if (objSecciones.status) {
          for (var j = 0; j < arrSecciones.length; j++) {
            var cadena = '<option value="' + arrSecciones[j].id + '">' + arrSecciones[j].nombre + '</option>';
            document.getElementById('tblSecciones').innerHTML += cadena;

          }
        }
      }
    }
    xhr.open('GET', 'http://app.cifo.local/api/public/biblioteca/secciones/', true);
    xhr.send();

    /* *****************************************   GET Temas  llamada AJAX ********************************************************** */

    document.getElementById("tblSecciones").onchange = function() {
      document.getElementById("tblTemas").innerHTML = '<option value="">-- Escoge un Tema --</option>';

      var xhr;
      xhr = new XMLHttpRequest();

      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4 && xhr.status == 200) {
          var arrTemas = JSON.parse(this.responseText);
          console.log(arrTemas.status);
          console.log(arrTemas.records);

          for (j in arrTemas.records) {
            var cadena = '<option value=' + arrTemas.records[j].id + '>';
            cadena += arrTemas.records[j].nombre + '</option>';
            document.getElementById('tblTemas').innerHTML += cadena;
          }
        }
      }
      xhr.open("GET", "http://app.cifo.local/api/public/biblioteca/temas/seccion/" + this.value + "/" + "&nocache=" + Math.random(), true);
      xhr.send(null);

    }


    /* ****************************************   GET Editoriales    llamada AJAX ***************************************************** */

    var xhr8;
    xhr8 = new XMLHttpRequest();
    xhr8.onreadystatechange = function() {
      if (xhr8.readyState == 4 && xhr8.status == 200) {
        var arrEditoriales = JSON.parse(this.responseText);
        console.log(arrEditoriales.status);
        console.log(arrEditoriales.records);

        for (j in arrEditoriales.records) {
          var cadena = '<option value=' + arrEditoriales.records[j].id + '>';
          cadena += arrEditoriales.records[j].nombre + '</option>';
          document.getElementById('tblEditoriales').innerHTML += cadena;
        }
      }

    }
    xhr8.open("GET", "http://app.cifo.local/api/public/biblioteca/editoriales/", true);
    xhr8.send();

    // ******************************************   RELLENO datatable ***************************************************************


    var tabla = $('#tbllibros').DataTable({

        language: {
          url: "./spanish.datatable.json"
        },

        lengthMenu: [5, 10, 25, 50, 75, 100],
        pageLength: 5,
        columnDefs: [{
            "data": "isbn",
            "targets": 0
          },
          {
            "data": "cubierta",
            "targets": 1
          },
          {
            "data": "titulo",
            "targets": 2
          },
          {
            "data": "editorial",
            "targets": 3
          },
          {
            "data": "seccion",
            "targets": 4
          },
          {
            "data": "tema",
            "targets": 5
          }
        ]

    });



    /* *********************************************   GET libros  **************************************************************************** */


    var xhr7;
    xhr7 = new XMLHttpRequest();

    xhr7.onreadystatechange = function() {
      if (xhr7.readyState == 4 && xhr7.status == 200) {
        var objLibros = JSON.parse(xhr7.responseText);

        console.log(objLibros);
        var arrLibros = objLibros.records;
        console.log(arrLibros);
        for (var i = 0; i < arrLibros.length; i++) {
          tabla.row.add({
            "isbn": '<a href="javascript:void(0)" onclick="viewLibro(' + arrLibros[i].id + ')">' + arrLibros[i].isbn + '</a>',
            "cubierta": '<img src="' + arrLibros[i].cubierta + '" height="30px">',
            "titulo": arrLibros[i].titulo,
            "editorial": arrLibros[i].editorial,
            "seccion": arrLibros[i].seccion,
            "tema": arrLibros[i].tema
          });
        }
        tabla.draw();

      }
    }

    xhr7.open('GET', 'http://app.cifo.local/api/public/biblioteca/libros/', true);
    xhr7.send();



    // <!-- *********************************************   FILTRAJE  relleno datatable via AJAX**************************************************** -->


    document.getElementById("btnFiltrar").onclick = function() {

      tabla.clear().draw();
      var seccionId = document.getElementById("tblSecciones").value;
      var temasId = document.getElementById("tblTemas").value;
      var editorialId = document.getElementById("tblEditoriales").value;
      console.log(seccionId);
      console.log(temasId);
      console.log(editorialId);
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4 && xhr.status == 200) {
          var objLibros = JSON.parse(xhr.responseText);
          var arrLibros = objLibros.records;
          console.log(objLibros);
          console.log(arrLibros);
          for (var i = 0; i < arrLibros.length; i++) {
            tabla.row.add({

              "isbn": '<a href="javascript:void(0)" onclick="viewLibro(' + arrLibros[i].id + ')" >' + arrLibros[i].isbn + '</a>',
              "cubierta": '<img src="' + arrLibros[i].cubierta + '" height="30px">',
              "titulo": arrLibros[i].titulo,
              "editorial": arrLibros[i].editorial,
              "seccion": arrLibros[i].seccion,
              "tema": arrLibros[i].tema
            })
          }
          tabla.draw();
        }
      }

      if (seccionId == "" && temasId == "") {
        xhr.open('GET', 'http://app.cifo.local/api/public/biblioteca/libros/', true);
      }

      if (!seccionId == "" && temasId == "") {
        xhr.open('GET', 'http://app.cifo.local/api/public/biblioteca/libros/seccion/' + seccionId + '/', true);

      }

      if (!seccionId == "" && !temasId == "") {
        xhr.open('GET', 'http://app.cifo.local/api/public/biblioteca/libros/seccion/' + seccionId + '/tema/' + temasId + '/', true);

      }

      if (seccionId == "" && !editorialId == "") {
        xhr.open('GET', 'http://app.cifo.local/api/public/biblioteca/libros/editoriales/' + editorialId + '/', true);

      }

      if (!seccionId == "" && !editorialId == "") {
        xhr.open('GET', 'http://app.cifo.local/api/public/biblioteca/libros/seccion/' + seccionId + '/editorial/' + editorialId + '/', true);

      }

      if (!seccionId == "" && !temasId == "" && !editorialId == "") {
        xhr.open('GET', 'http://app.cifo.local/api/public/biblioteca/libros/seccion/' + seccionId + '/tema/' + temasId + '/editorial/' + editorialId + '/', true);

      }
      xhr.send();
    }

    // ************************************************  BOTON de borraje ***********************************************************************

    document.getElementById("btnBorrar").onclick = function() {
      document.getElementById("tblSecciones").value = "";
      document.getElementById("tblTemas").value = "";
      document.getElementById("tblEditoriales").value = "";
    }

    // ************************************************* MODAL Relleno libro via API  AJAX********************************************************

    function viewLibro(id) {
      console.log(id);

      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4 && xhr.status == 200) {
          var objlibroModal = JSON.parse(xhr.responseText);
          console.log(objlibroModal);
          var libroModal = objlibroModal.record;
          console.log(libroModal);
          var values = Object.values(libroModal);
          console.log(values);
          document.getElementById("isbnModal").innerHTML = objlibroModal.record.isbn;
          document.getElementById("tituloModal").innerHTML = objlibroModal.record.titulo;
          document.getElementById("subtituloModal").innerHTML = objlibroModal.record.subtitulo;
          document.getElementById("paginaModal").innerHTML = objlibroModal.record.pagina;
          document.getElementById("editorialModal").innerHTML = objlibroModal.record.editorial;
          document.getElementById("anoModal").innerHTML = objlibroModal.record.anio_publicacion;
          document.getElementById("temaModal").innerHTML = objlibroModal.record.tema;
          document.getElementById("seccionModal").innerHTML = objlibroModal.record.seccion;
          document.getElementById("nivelModal").innerHTML = objlibroModal.record.nivel;
          document.querySelector("#collapseOne div.card-body").innerHTML = objlibroModal.record.descripcion;


          document.querySelector("#collapseTwo div.card-body").innerHTML = "";

          for (var i = 0; i < objlibroModal.record.autores.length; i++) {
            if (i != 0) {
              document.querySelector("#collapseTwo div.card-body").innerHTML += "<hr />";
            }
            console.log(objlibroModal.record.autores[i].nombre);
            console.log(document.querySelector("#collapseTwo div.card-body"));

            document.querySelector("#collapseTwo div.card-body").innerHTML += '<img  class="" style="float ; padding-right: 15px;padding-bottom: 15px; width:120px;" src="' + objlibroModal.record.autores[i].foto + '"   />';
              document.querySelector("#collapseTwo div.card-body").innerHTML += '<strong>' +objlibroModal.record.autores[i].nombre+ '</strong>';
            document.querySelector("#collapseTwo div.card-body").innerHTML += '<p>' + objlibroModal.record.autores[i].biografia + '</p>';
            document.getElementById("fotolibroModal").src = objlibroModal.record.cubierta;

          }
        }

      }
      xhr.open('GET', 'http://app.cifo.local/api/public/biblioteca/libros/' + id + '/', true);
      xhr.send();

      $('#ModalLibro').modal('show')
    }
  </script>
</body>


</html>
